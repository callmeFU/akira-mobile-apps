<ons-page id="Riwayat">
    <ons-pull-hook id="pull-hook" threshold-height="120px">
        <ons-icon id="pull-hook-icon" size="22px" class="pull-hook-content" icon="fa-arrow-down"></ons-icon>
    </ons-pull-hook>
    <ons-list id="riwayatReservasi">
        <ons-list-header>Riwayat transaksi anda</ons-list-header>
        <!-- <ons-list-item modifier="chevron" tappable id="riwayat-1">
            <span>12-11-2017 : 13.00</span>
            <ons-row>
                <ons-col>
                    Paket Jasa
                </ons-col>
            </ons-row>
            <ons-row>
                <ons-col>
                    nama terapis
                </ons-col>
            </ons-row>
            <ons-row>
                <ons-col>
                    Akira Reflexology
                </ons-col>
            </ons-row>
            <ons-row>
                <ons-col>
                    Rp. 4k
                </ons-col>
            </ons-row>
        </ons-list-item> -->
    </ons-list>
    <script>
        ons.getScriptPage().onShow = function () {
            Authenticate();
            tampilkanRiwayatSaya();
            var pullHook = document.getElementById('pull-hook');
            var icon = document.getElementById('pull-hook-icon');
            pullHook.addEventListener('changestate', function (event) {
                switch (event.state) {
                    case 'initial':
                        icon.setAttribute('icon', 'fa-arrow-down');
                        icon.removeAttribute('rotate');
                        icon.removeAttribute('spin');
                        break;
                    case 'preaction':
                        icon.setAttribute('icon', 'fa-arrow-down');
                        icon.setAttribute('rotate', '180');
                        icon.removeAttribute('spin');
                        break;
                    case 'action':
                        icon.setAttribute('icon', 'fa-spinner');
                        icon.removeAttribute('rotate');
                        icon.setAttribute('spin', true);
                        break;
                }
            });
            pullHook.onAction = function (done) {
                setTimeout(function () {
                    $('#riwayatReservasi').empty();
                    $('#riwayatReservasi').append('<ons-list-header>Riwayat transaksi anda</ons-list-header>');
                    tampilkanRiwayatSaya();
                    done();
                }, 1000);
            }
        };
        function tampilkanRiwayatSaya() {
            $("#riwayatReservasi").empty();
            let loadingCircle = $("<div style='text-align:center;'> <ons-progress-circular id='loading'  indeterminate></ons-progress-circular></div>");
            $("#riwayatReservasi").append(loadingCircle);
            let totalHargaUser = 0;
            $.ajax({
                type: 'GET',
                url: _URL + '{headerReservasi(username: "' + _ID_USER + '") {id, tanggal_reservasi, kode, detail_reservasi{ header_reservasi_id, produk_id{waktu,nama,harga,kode}karyawan_id{nama}},status_reservasi {status,progress}}}',
                success: function (reservasi) {
                    console.log(reservasi);
                    $('#loading').remove();
                    $("#riwayatReservasi").empty();
                    $('#riwayatReservasi').append('<ons-list-header>Riwayat transaksi anda</ons-list-header>');
                    $.each(reservasi.data.headerReservasi, function (key, reser) {
                        if (reser.status_reservasi[0].progress != "checkin" || (reser.status_reservasi[0].progress == "diterima" && reser.status_reservasi[0].status == "ditolak") || (reser.status_reservasi[0].progress == "batal" && reser.status_reservasi[0].status == "batal")) {
                            if (reser.status_reservasi[0].progress == "diterima" && reser.status_reservasi[0].status == "pending") {
                                console.log("asw");
                            } else {
                                let tanggal = reser.tanggal_reservasi;
                                let thn = tanggal.substr(0, 4);
                                let bln = tanggal.substr(5, 2);
                                let hari = tanggal.substr(8, 2);
                                let jam = tanggal.substr(11, 5);
                                let tanggal2 = hari + '-' + bln + '-' + thn + ', ' + jam;
                                let id = reser.id;
                                var list = $("<ons-list-item expandable><span><strong>" + tanggal2 + "</strong></span><div class='expandable-content' id='list-content-" + key + "'><span>Tempat\t : Akira Reflexology</span><br></div></ons-list-item>");
                                $("#riwayatReservasi").append(list);
                                //looping pesanannya
                                $.each(reservasi.data.headerReservasi[key].detail_reservasi, function (key1, detail) {
                                    let idIsiReservasi = detail.header_reservasi_id;
                                    if (idIsiReservasi == id) {
                                        totalHargaUser = totalHargaUser + detail.produk_id.harga;
                                        var isiList = $('<span>Jasa\t : ' + detail.produk_id.nama + ', ' + detail.produk_id.waktu + '</span><br><span>Nama Terapis\t: ' + detail.karyawan_id.nama + '</span><span>Status : ' + reser.status_reservasi[0].status + '<hr width="98%">');
                                        $('#list-content-' + key).append(isiList);
                                    }

                                });
                                // var hargaDanTombol = $('<span>Pesanan Anda : ' + reser.status_reservasi[0].status + '</span><br><span>Estimasi Harga : ' + numberWithCommas(totalHargaUser) + '</span><hr width="98%"><ons-button id="reservasi-' + key + '">Batal</ons-button>');
                                // $('#isi-list-content-' + key).append(hargaDanTombol);
                                // totalHargaUser = 0;
                                // $('#reservasi-' + key).on('click', function () {
                                //     idReservasi = reser.kode;
                                //     console.log(idReservasi);
                                //     $('#isi-batal').append('Anda yakin akan membatalkan reservasi pada tanggal <br>' + tanggal2 + '?');
                                //     // $('.alert-dialog-footer2').append('<ons-row><ons-col width="48%"><button class="alert-dialog-button" onclick="hideDialogReser()">Batal</button></ons-col><ons-col width="4%"></ons-col><ons-col width="48%"><button class="alert-dialog-button" id="fix-batal">Oke</button></ons-col></ons-row>');
                                //     var dialog = document.getElementById('batal-dialog');
                                //     if (dialog) {
                                //         dialog.show();
                                //     }
                                // });
                            }
                        }

                    });
                },
                error: function (data) {
                    console.log(data);
                }
            });

        };
    </script>
</ons-page>